{% extends "base.html" %}
{% block body %}
{% from "helper/formhelpers.html" import render_input_field%}

<link rel="stylesheet" href="{{ url_for('static', filename='vendors/fullcalendar/1.6.4/fullcalendar.css') }}">

<script src="{{ url_for('static', filename='vendors/jquery-ui.custom.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/underscore-1.5.2.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/backbone-1.1.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendors/fullcalendar/1.6.4/fullcalendar.js') }}"></script>

<div class="container">
   <div class="col-md-3">

   </div>
   
   <div id="right_col" class="col-md-9">
      <div class="row">
         
         <button class="btn btn-primary pull-right" data-toggle="modal" data-target="#createEventModal">Add Event</button>
         
      </div>
      
      <div class="row" id="event_list_content">

      </div>
	</div>
</div>


<div class="modal fade" id="createEventModal" tabindex="-1" role="dialog" aria-labelledby="createEventModal" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Add New Event</h4>
         </div>
         <div class="modal-body">
            <form id="create_form" action="{{ url_for('calendar.new_event', c_id=community.id) }}"  method=post>
               {{ form.csrf_token }}
               <div class="form-group">
                  <label>Name</label>
                   {{ render_input_field(form.name, "Event Name") }}
               </div>
               <div class="form-group">
                  <label>Starts</label>
                   {{ render_input_field(form.start, "Start Date and Time")}}
               </div>
               <div class="form-group">
                  <label>Ends</label>
                   {{ render_input_field(form.end, "End Date and Time")}}
               </div>              
               <div class="form-group">
                  <label>Description</label>
                  {{ render_input_field(form.description, "Event Description") }}
               </div>
            </form>
         </div>
         <div class="modal-footer">
            <button id="create_event" type="button" class="btn btn-primary" type="submit">Create</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
         </div>
      </div><!-- /.modal-content -->
   </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" id="updateEventModal" tabindex="-1" role="dialog" aria-labelledby="updateEventModal" aria-hidden="true">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title" id="myModalLabel">Edit Event</h4>
         </div>
         <div class="modal-body">
            <form id="update_form" action="{{ url_for('calendar.update_event', e_id=11) }}"  method=post>
               {{ form.csrf_token }}
               <div class="form-group">
                  <label>Name</label>
                   {{ render_input_field(form.name, "Event Name") }}
               </div>
               <div class="form-group">
                  <label>Starts</label>
                   {{ render_input_field(form.start, "Start Date and Time")}}
               </div>
               <div class="form-group">
                  <label>Ends</label>
                   {{ render_input_field(form.end, "End Date and Time")}}
               </div>              
               <div class="form-group">
                  <label>Description</label>
                  {{ render_input_field(form.description, "Event Description") }}
               </div>
            </form>
         </div>
         <div class="modal-footer">
            <button id="update_event" type="button" class="btn btn-primary" type="submit">Edit</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
         </div>
      </div><!-- /.modal-content -->
   </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!--
<script id="event-list-template" type="text/x-handlebars-template">
{% raw %}
   {{#if this}}
   <ul class="event_items">

      {{#each this}}
      <li id="event_{{id}}">
         {{id}}
         {{title}}  
         {{start}}
         <button class="delete_event btn btn-info pull-right" data-url="{{action.delete}}">
            Delete
         </button>
         <button class="update_event btn btn-info pull-right" data-toggle="modal" data-target="#updateEventModal">
            Update
         </button>    
      </li>

      {{/each}}
   </ul>
   {{else}}
      <h3>No scheduled events yet!</h3>
   {{/if}}
{% endraw %}
</script>
-->

<script type=text/javascript>
$(function(){

    var Event = Backbone.Model.extend();
 
    var Events = Backbone.Collection.extend({
        model: Event,
        url: '{{ url_for('calendar.list', c_id=community.id) }}',

        parse: function(response){
            return response.data;
        }
    });
 
    var EventsView = Backbone.View.extend({
        initialize: function(){
            _.bindAll.apply(_, [this].concat(_.functions(this)))
 
            this.collection.bind('reset', this.addAll);
            this.collection.bind('add', this.addOne);
            this.collection.bind('change', this.change);
            this.collection.fetch();
        },
        render: function() {
            this.$el.fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay',
                    ignoreTimezone: false
                },
                selectable: true,
                selectHelper: true,
                editable: true,
                allDayDefault: false,
                select: this.select,
                eventClick: this.eventClick,
                eventDrop: this.eventDropOrResize,
                eventResize: this.eventDropOrResize
            });
        },
        addAll: function(){
            this.$el.fullCalendar('addEventSource', this.collection.toJSON());
        },
        select: function(startDate, endDate) {
            var eventView = new EventView();
            eventView.collection = this.collection;
            eventView.model = new Event({start: startDate, end: endDate});
            eventView.render();
            
        },
        addOne: function(event) {
            this.$el.fullCalendar('renderEvent', event.toJSON());
        },
        change: function(event) {
            var fcEvent = this.$el.fullCalendar('clientEvents', event.get('id'))[0];
            fcEvent.title = event.get('title');
            fcEvent.color = event.get('color');
            this.$el.fullCalendar('updateEvent', fcEvent);
        }, 
        eventClick: function(fcEvent) {
            this.eventView.model = this.collection.get(fcEvent.id);
            this.eventView.render();
        },
        eventDropOrResize: function(fcEvent) {
            this.collection.get(fcEvent.id).save({start: fcEvent.start, end: fcEvent.end});
            alert(JSON.stringify(fcEvent));
        }
    });
 
    var EventView = Backbone.View.extend({
        el: $('#eventDialog'),
        initialize: function() {
            _.bindAll.apply(_, [this].concat(_.functions(this)))
        },
        render: function() {
            this.$el.dialog({
                modal: true,
                title: (this.model.isNew() ? 'New' : 'Edit') + ' Event',
                buttons: {'Ok': this.save, 'Cancel': this.close},
                open: this.open
            });
 
            return this;
        },
        open: function() {
            this.$('#title').val(this.model.get('title'));
            this.$('#color').val(this.model.get('color'));
        },
        save: function() {
            this.model.set({'title': this.$('#title').val(), 'color': this.$('#color').val()});
            if (this.model.isNew()){
                this.collection.create(this.model, {success: this.close});
            }else{
                this.model.save({}, {success: this.close});
            }
        },
        close: function() {
           this.$el.dialog('close');
        }
    });

    var events = new Events();
    new EventsView({el: $("#event_list_content"), collection: events}).render();
});
</script>

<!--
<script type=text/javascript>
var display = '{{community.id}}';
var source   = $("#event-list-template").html();
var eventListTemplate = Handlebars.compile(source);

function update_event_list(){
   $.get('{{ url_for('calendar.list', c_id=community.id) }}')
      .done(function(result){
         var content = $("#event_list_content");
         content.empty();
         var html    = eventListTemplate(result.data);
         content.append(html); 
   });
}

function delete_event(url){
   $.ajax({
      type: 'POST',
      url: url,
   }).done(function(result){
      if(result.success){
         update_event_list();
      }else{
         console.log(result);
         alert(result.errors);
      }
   }).fail(function(errors){
      console.log(errors);
   });
}

$( document ).ready(function() {
   if(display == 'all'){
      $(".btn").css('display', 'none');
   }
   update_event_list();

   $("#create_event").click(function(){
      var form = $("#create_form");
      var data = form.serialize();
      $.ajax({
         type: form.attr('method'),
         url: form.attr('action'),
         data: data,
      }).done(function(data){
         //remove errors
         form.find(".form_field").each(function(){
            $(this).removeClass('has-error');
            $(this).find('ul.error_message').empty();
         });

         if(data.success){
            $('#createEventModal').modal('hide');
            update_event_list();
         }else{
            //raise error
            $.each(data.errors, function(field, errors){
               var error_field = $("#"+field);
               error_field.addClass('has-error');
               $.each(errors, function(key, e){
                  error_field.find('ul.error_message').append("<li>"+e+"</li>");
               });
            });
         }
      }).fail(function(error){
         console.log(error);
      });
   });

   $("#update_event").click(function(){
      var form = $("#update_form");
      var data = form.serialize();
      $.ajax({
         type: form.attr('method'),
         url: form.attr('action'),
         data: data,
      }).done(function(data){
         //remove errors
         form.find(".form_field").each(function(){
            $(this).removeClass('has-error');
            $(this).find('ul.error_message').empty();
         });

         if(data.success){
            $('#updateEventModal').modal('hide');
            update_event_list();
         }else{
            //raise error
            $.each(data.errors, function(field, errors){
               var error_field = $("#"+field);
               error_field.addClass('has-error');
               $.each(errors, function(key, e){
                  error_field.find('ul.error_message').append("<li>"+e+"</li>");
               });
            });
         }
      }).fail(function(error){
         console.log(error);
      });
   });

   $(document).on('click','.delete_event', function(e){
      var id = $(this).parent().attr('id').split("_")[1];
      var dialog = confirm("Do you want to delete this event?");
      if(dialog)
         delete_event($(this).attr('data-url'));
   });

});
</script>
-->

{% endblock %}